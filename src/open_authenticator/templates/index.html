<!DOCTYPE html>
<html>
<head>
    <title>TOTP Authenticator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #accountInfo { margin-bottom: 20px; font-weight: bold; }
        .hidden { display: none; }
        .form-group { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Authenticator</h1>
    <div id="accountInfo" class="hidden"></div>
    <div id="authForm">
        <div class="form-group">
            <label for="emailInput">Email:</label>
            <input type="email" id="emailInput">
            <button onclick="generateOTP()">Send OTP</button>
        </div>
        <div class="form-group hidden" id="otpSection">
            <label for="otpInput">OTP:</label>
            <input type="text" id="otpInput">
            <button onclick="verifyOTP()">Verify</button>
        </div>
    </div>
    <div id="message"></div>
    <div id="listSection" class="hidden">
        <h2>Your OTP Info</h2>
        <pre id="otpList"></pre>
        <button onclick="listOtps()">Refresh</button>
        <button onclick="logout()">Logout</button>
    </div>
    <script>
        function generateOTP() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email) { alert('Enter email'); return; }
            fetch('/api/otp/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: email, operation: 'login' })
            }).then(r => r.json()).then(data => {
                document.getElementById('message').textContent = data.message || '';
                if (data.status === 'success' || data.status === 'info' || data.status === 'warning') {
                    document.getElementById('otpSection').classList.remove('hidden');
                }
            });
        }
        function verifyOTP() {
            const email = document.getElementById('emailInput').value.trim();
            const otp = document.getElementById('otpInput').value.trim();
            fetch('/api/otp/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: email, otp: otp })
            }).then(r => r.json().then(d => ({status:r.status, body:d}))).then(res => {
                if (res.status === 200 && res.body.status === 'success') {
                    sessionStorage.setItem('email', email);
                    sessionStorage.setItem('otp', otp);
                    document.getElementById('accountInfo').textContent = 'Logged in as ' + email;
                    document.getElementById('accountInfo').classList.remove('hidden');
                    document.getElementById('listSection').classList.remove('hidden');
                    listOtps();
                } else {
                    document.getElementById('message').textContent = res.body.message;
                    document.getElementById('emailInput').value = '';
                }
            });
        }
        function listOtps() {
            const email = sessionStorage.getItem('email');
            if (!email) return;
            fetch(`/api/otp/list/${encodeURIComponent(email)}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('otpList').textContent = JSON.stringify(data, null, 2);
                });
        }
        function logout() {
            sessionStorage.clear();
            document.getElementById('listSection').classList.add('hidden');
            document.getElementById('accountInfo').classList.add('hidden');
            document.getElementById('otpSection').classList.add('hidden');
            document.getElementById('emailInput').value = '';
            document.getElementById('otpInput').value = '';
        }
        document.addEventListener('DOMContentLoaded', function() {
            const email = sessionStorage.getItem('email');
            if (email) {
                document.getElementById('accountInfo').textContent = 'Logged in as ' + email;
                document.getElementById('accountInfo').classList.remove('hidden');
                document.getElementById('listSection').classList.remove('hidden');
                listOtps();
            }
        });
    </script>
</body>
</html>
